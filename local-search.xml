<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>kubernetes本地安装部署</title>
    <link href="/2023/12/22/kubernetes%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <url>/2023/12/22/kubernetes%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="本地环境"><a href="#本地环境" class="headerlink" title="本地环境"></a>本地环境</h2><ol><li>MacOS M1</li><li>虚拟机: Paralles Desktop</li><li>虚拟机管理工具: vagrant</li></ol><h2 id="vagrant-配置如下"><a href="#vagrant-配置如下" class="headerlink" title="vagrant 配置如下"></a>vagrant 配置如下</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable constant_">NUM_WORKER_NODES</span>=<span class="hljs-number">2</span><br><span class="hljs-variable constant_">IP_NW</span>=<span class="hljs-string">&quot;10.1.0.&quot;</span><br><span class="hljs-variable constant_">IP_START</span>=<span class="hljs-number">10</span><br><br><span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&#x27;VAGRANT_NO_PARALLEL&#x27;</span>] = <span class="hljs-string">&#x27;yes&#x27;</span><br><br><span class="hljs-title class_">Vagrant</span>.<span class="hljs-title function_">configure</span>(<span class="hljs-string">&quot;2&quot;</span>) <span class="hljs-keyword">do</span> |config|<br>    config.<span class="hljs-property">vm</span>.<span class="hljs-property">provision</span> <span class="hljs-string">&quot;shell&quot;</span>, <span class="hljs-attr">inline</span>: &lt;&lt;-<span class="hljs-variable constant_">SHELL</span><br>        apt-get update -y<br>        echo <span class="hljs-string">&quot;$IP_NW$((IP_START))  master-node&quot;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>hosts<br>        echo <span class="hljs-string">&quot;$IP_NW$((IP_START+1))  worker-node01&quot;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>hosts<br>        echo <span class="hljs-string">&quot;$IP_NW$((IP_START+2))  worker-node02&quot;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>hosts<br>    <span class="hljs-variable constant_">SHELL</span><br>    config.<span class="hljs-property">vm</span>.<span class="hljs-property">box</span> = <span class="hljs-string">&quot;jharoian3/ubuntu-22.04-arm64&quot;</span><br>    config.<span class="hljs-property">vm</span>.<span class="hljs-property">box_check_update</span> = <span class="hljs-literal">true</span><br><br>    config.<span class="hljs-property">vm</span>.<span class="hljs-property">define</span> <span class="hljs-string">&quot;master&quot;</span> <span class="hljs-keyword">do</span> |master|<br>      master.<span class="hljs-property">vm</span>.<span class="hljs-property">hostname</span> = <span class="hljs-string">&quot;master-node&quot;</span><br>      master.<span class="hljs-property">vm</span>.<span class="hljs-property">network</span> <span class="hljs-string">&quot;private_network&quot;</span>, <span class="hljs-attr">ip</span>: <span class="hljs-variable constant_">IP_NW</span> + <span class="hljs-string">&quot;#&#123;IP_START&#125;&quot;</span><br>      master.<span class="hljs-property">vm</span>.<span class="hljs-property">provider</span> <span class="hljs-string">&quot;parallels&quot;</span> <span class="hljs-keyword">do</span> |vb|<br>          vb.<span class="hljs-property">memory</span> = <span class="hljs-number">3072</span><br>          vb.<span class="hljs-property">cpus</span> = <span class="hljs-number">3</span><br>      end<br>    end<br><br><br>    (<span class="hljs-number">1.</span>.<span class="hljs-property">NUM_WORKER_NODES</span>).<span class="hljs-property">each</span> <span class="hljs-keyword">do</span> |i|<br>      config.<span class="hljs-property">vm</span>.<span class="hljs-property">define</span> <span class="hljs-string">&quot;node0#&#123;i&#125;&quot;</span> <span class="hljs-keyword">do</span> |node|<br>        node.<span class="hljs-property">vm</span>.<span class="hljs-property">hostname</span> = <span class="hljs-string">&quot;worker-node0#&#123;i&#125;&quot;</span><br>        node.<span class="hljs-property">vm</span>.<span class="hljs-property">network</span> <span class="hljs-string">&quot;private_network&quot;</span>, <span class="hljs-attr">ip</span>: <span class="hljs-variable constant_">IP_NW</span> + <span class="hljs-string">&quot;#&#123;IP_START + i&#125;&quot;</span><br>        node.<span class="hljs-property">vm</span>.<span class="hljs-property">provider</span> <span class="hljs-string">&quot;parallels&quot;</span> <span class="hljs-keyword">do</span> |vb|<br>            vb.<span class="hljs-property">memory</span> = <span class="hljs-number">1536</span><br>            vb.<span class="hljs-property">cpus</span> = <span class="hljs-number">2</span><br>        end<br>      end<br>    end<br>  end<br><br></code></pre></td></tr></table></figure><blockquote><p>配置中特别需要注意的点就是需要用到的镜像，需要使用arm架构的镜像，并且需要支持parallels。我这里使用的是jharoian3&#x2F;ubuntu-22.04-arm64，你也可以去vagrant的镜像库去找一找。</p></blockquote><h2 id="需要在虚拟机中执行的脚本"><a href="#需要在虚拟机中执行的脚本" class="headerlink" title="需要在虚拟机中执行的脚本"></a>需要在虚拟机中执行的脚本</h2><p>这里没有直接把sh加入到Vagrant的配置里，是因为我想一句一句去执行以下shell中的命令。因为个人环境千差万别，指不定就在哪一行出错了，以这样的方式能快速定位问题，解决问题</p><ol><li>common.sh</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">! /bin/bash</span><br><br>KUBERNETES_VERSION=&quot;1.28.4-00&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Make sure Ubuntu has the lates updates</span><br>sudo apt update<br>sudo apt -y full-upgrade<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Add the Google Kubernetes repo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sudo apt -y install curl apt-transport-https gnupg2 ca-certificates</span><br>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -<br>echo &quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Install the kubelet, kubectl and kubeadm</span><br>sudo apt update<br>sudo apt -y install kubelet=&quot;$KUBERNETES_VERSION&quot; kubectl=&quot;$KUBERNETES_VERSION&quot; kubeadm=&quot;$KUBERNETES_VERSION&quot;<br>sudo apt-mark hold kubelet kubeadm kubectl<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Get rid of the swap</span><br>sudo sed -i &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab<br>sudo swapoff -a<br>sudo mount -a<br>free -h<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Configure the needed modules and persist them</span><br>sudo modprobe overlay<br>sudo modprobe br_netfilter<br><br>sudo tee /etc/modules-load.d/containerd.conf &lt;&lt;EOF<br>overlay<br>br_netfilter<br>EOF<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Ensure sysctl params are <span class="hljs-built_in">set</span></span><br>sudo tee /etc/sysctl.d/kubernetes.conf&lt;&lt;EOF<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>EOF<br><br>sudo sysctl --system<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Add Docker repo</span><br>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -<br>sudo add-apt-repository &quot;deb https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Install containerd</span><br>sudo apt update<br>sudo apt install -y containerd.io<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Configure containerd and start the service</span><br>sudo mkdir -p /etc/containerd<br>containerd config default | sudo tee /etc/containerd/config.toml<br>sudo sed -i &#x27;s/            SystemdCgroup = false/            SystemdCgroup = true/&#x27; /etc/containerd/config.toml<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Start both containerd and kubelet</span><br>sudo systemctl restart containerd<br>sudo systemctl enable containerd<br>sudo systemctl enable kubelet<br><br></code></pre></td></tr></table></figure><ol start="2"><li>master.sh</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">! /bin/bash</span><br><br>MASTER_IP=&quot;10.1.0.10&quot;<br>NODENAME=$(hostname -s)<br>POD_CIDR=&quot;192.168.0.0/16&quot;<br>KUBERNETES_VERSION=&quot;1.28.4&quot;<br>CILIUM_VERSION=&quot;1.12.3&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Pull the kubernetes images</span><br>sudo kubeadm config images pull <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Init Kubernetes</span><br>sudo kubeadm init \<br>--skip-phases=addon/kube-proxy \<br>--apiserver-advertise-address=$MASTER_IP  \<br>--apiserver-cert-extra-sans=$MASTER_IP \<br>--pod-network-cidr=$POD_CIDR \<br>--node-name $NODENAME<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">KUBECONFIG <span class="hljs-keyword">for</span> in-VM kubectl usage</span><br>mkdir -p $HOME/.kube<br>sudo cp -f /etc/kubernetes/admin.conf $HOME/.kube/config<br>sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Untaint the control node to be used as a worker too</span><br>kubectl taint nodes --all node-role.kubernetes.io/master-<br>kubectl taint nodes --all  node-role.kubernetes.io/control-plane-<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Install helm</span><br>sudo snap install helm --classic<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Install Cilium wiht its helm chart</span><br>helm repo add cilium https://helm.cilium.io/<br>helm install cilium cilium/cilium \<br>--version $CILIUM_VERSION \<br>--namespace kube-system \<br>--set kubeProxyReplacement=strict \<br>--set k8sServiceHost=$MASTER_IP \<br>--set k8sServicePort=6443   \<br>--set hubble.listenAddress=&quot;:4244&quot; \<br>--set hubble.relay.enabled=true \<br>--set hubble.ui.enabled=true  <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Generete KUBECONFIG on the host</span><br>sudo cp -f /etc/kubernetes/admin.conf /vagrant/configs/config<br><span class="hljs-meta prompt_"># </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /vagrant/configs/join.sh</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sudo <span class="hljs-built_in">chmod</span> +x /vagrant/configs/join.sh</span>       <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Generete the kubeadm <span class="hljs-built_in">join</span> <span class="hljs-built_in">command</span> on the host</span><br>kubeadm token create --print-join-command | sudo tee /vagrant/configs/join.sh<br><br></code></pre></td></tr></table></figure><ol start="3"><li>node.sh</li></ol><p>node 本质上只需要Join进集群就行，config可以不用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">! /bin/bash</span><br><br>NODENAME=$(hostname -s)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Join the control node</span><br>/bin/bash /vagrant/configs/join.sh -v<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">KUBECONFIG <span class="hljs-keyword">for</span> in-VM kubectl usage</span><br>sudo -i -u vagrant bash &lt;&lt; EOF<br>mkdir -p /home/vagrant/.kube<br>sudo cp -i /vagrant/configs/config /home/vagrant/.kube/<br>sudo chown 1000:1000 /home/vagrant/.kube/config<br>kubectl label node $(hostname -s) node-role.kubernetes.io/worker=worker-new<br>EOF<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
